image: golang:1.13.1-buster

stages:
  - test
  - broker
  - deploy

.gobuild:
  stage: test
  before_script:
    - go version
  script:
    - make
    - make cover
  only:
    refs:
      - master
      - dev

go1.13:
  image: golang:1.13-buster
  extends: .gobuild

go1.14:
  image: golang:1.14-buster
  extends: .gobuild

go1.15:
  image: golang:1.15-buster
  extends: .gobuild

.teste2e:
  script:
    - apt-get update -y && apt-get install -y mosquitto-clients
    - make etoe
  needs:
    - job: go1.13
    - job: go1.14
    - job: go1.15
  only:
    refs:
      - master
      - dev

# Must Mosquitto >= 1.6
# https://github.com/eclipse/mosquitto/blob/master/ChangeLog.txt#L616
test mosquitto 1.6:
  stage: broker
  services:
    - name: eclipse-mosquitto:1.6
  variables:
    MQTT: "eclipse-mosquitto:1883"
  extends: .teste2e

test emqx:
  stage: broker
  before_script:
    - apt-get update -y && apt-get install -y mosquitto-clients
    - wget https://github.com/emqx/emqx/releases/download/v4.2.3/emqx-debian10-4.2.3-x86_64.deb
    - dpkg -i emqx-debian10-4.2.3-x86_64.deb
    - service emqx start
  extends: .teste2e

packaging:
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  stage: deploy
  script:
    - apt-get update -y && apt-get install -y xz-utils
    - tar -cJf - ./ | ssh build@api.sb.im -p 6001 'cd `bin/pre_build.sh ncp` && tar -xJf - && ~/bin/build.sh'
  only:
    - tags

deploy_simulation:
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SIMULATION_SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  stage: deploy
  script:
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/sbim/superdock/links/starlight.git".insteadOf git@gitlab.com:sbim/superdock/links/starlight.git
    - git submodule sync && git submodule update --init
    - make dep
    - apt-get update -y && apt-get install -y xz-utils
    - tar -cJf - ./ | ssh pi@api.sb.im -p 6002 'rm -rf ncp && mkdir -p ncp && cd ncp && tar -xJf - && PATH="$HOME/go/bin:$PATH" make build && ../ncp_restart.sh'
  only:
    refs:
      - master

